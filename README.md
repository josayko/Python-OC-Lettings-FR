# Epic Events CRM

[![CircleCI](https://circleci.com/gh/josayko/Python-OC-Lettings-FR/tree/master.svg?style=shield)](https://circleci.com/gh/josayko/Python-OC-Lettings-FR/tree/master)

## Summary

1. [Installation](#installation)
2. [Running the app](#running-the-app)
3. [Docker image](#docker-image)
4. [Pipeline CI/CD and Deployement](#pipeline-cicd-and-deployement)

## Installation

### Prerequisites

- `python >= 3.9`, `pip`, `venv`
- you can manage different `python` versions with **[pyenv](https://github.com/pyenv/pyenv)**
- `docker`

### Get started

#### Local development environment

```bash
$ python -m venv .venv
```

```bash
$ source .venv/bin/activate
```

```bash
$  pip install -r requirements.txt
```

#### Environement variables

- Generate a `.env.TEMPLATE` file

```
$ python setup_env.py
```

- Rename the file to `.env` and configure the variables:
  - DJANGO_SECRET_KEY
    - Random string, automatically generated by `setup_env.py` script
  - DEBUG
    - `true` or `false`
  - SENTRY_DSN
    - Create a new project on [sentry.io](https://sentry.io)
  - HEROKU_API_KEY and HEROKU_APP_NAME
    - Create a new app on [heroku.com](https://heroku.com)

#### Setting up database

- Migrate database

```bash
$ python manage.py migrate
```

- Populate some data in the database

```bash
$ make fixture
# alternatively:
# $ python manage.py loaddata users addresses lettings profiles
```

## Running the app

```bash
$ python manage.py runserver
```

> The API is running on http://localhost:8000/ by default

> You can access admin dashboard on http://localhost:8000/admin, if data has been loaded previously from `fixture/`, there is a default admin user `admin` with password `Abc1234!`

- Execute linting

```bash
$ flake8
```

- Execute unit tests

```bash
$ pytest
```

## Docker image

#### Build and run a docker image locally

- An image of the app will be build from `Dockerfile`

```bash
$ docker build -t [IMAGE_NAME] .
```

- Start a container from the image

```bash
$ docker run --rm -p 8000:8000 --env-file .env [IMAGE_NAME]
```

#### Pull and run the image from Docker Hub

- Sign in to Docker Hub

```bash
$ docker pull josayko/oc-lettings:latest
```

```bash
$ docker run --rm -p 8000:8000 --env-file .env josayko/oc-lettings:latest
```

## Pipeline CI/CD and Deployement

The pipeline has 3 main jobs, one must finish to do the next:

- `build_and_test`: will build the app, run unit tests and check linting everytime a change is pushed to any branch.
- `docker/publish`: build the app image from the Dockerfile and push it to the Docker Hub repository. Only when changes on master branch.
- `heroku/deploy-via-git`: deploy the app on heroku. Only when changes on master branch.

> To set up the pipeline you should do the following configurations in order.

> CircleCI dashboard example: [https://app.circleci.com/pipelines/github/josayko/Python-OC-Lettings-FR?branch=master](https://app.circleci.com/pipelines/github/josayko/Python-OC-Lettings-FR?branch=master)

> Heroku deployed app example: [https://oc-lettings-testing-1.herokuapp.com/](https://oc-lettings-testing-1.herokuapp.com/)

#### Sentry

- Create a new project on Sentry and fill in `SENTRY_DSN` in `.env`

#### Docker Hub

- Create a new repository named `oc-lettings`

#### Heroku

- Create a new Heroku app and fill in the `HEROKU_APP_NAME` in `.env`
- In your app `Settings > Config Vars`, set the following environment variables:
  - `DEBUG` set to 0 or false
  - `DJANGO_SECRET_KEY` same as in `.env`
  - `ENV` set to _`production`_
  - `SENTRY_DSN`, same as in `.env`

#### CircleCI

- Create a new project from existing `.circleci/config.yml` file in this repository.
- In your project `Project Settings > Environment Variables`, set the following variables:
  - `DEBUG` set to 0 or false
  - `DJANGO_SECRET_KEY`same as in _.env_
  - `DOCKER_LOGIN`, your Docker Hub login
  - `DOCKER_PASSWORD`, your Docker Hub password
  - `DOCKER_REPO`, e.g. _<your_docker_hub_login>/oc-lettings_
  - `HEROKU_API_KEY`, in Heroku _Account Settings > API Key_
  - `HEROKU_APP_NAME`, the name of your app on Heroku
  - `HEROKU_TOKEN`, same as `HEROKU_API_KEY`
  - `SENTRY_DSN`, same as in _.env_

## Author

- Jonny Saykosy <josayko@pm.me>

## License & copyright

Â© Jonny Saykosy

Licensed under the [MIT License](LICENSE).
